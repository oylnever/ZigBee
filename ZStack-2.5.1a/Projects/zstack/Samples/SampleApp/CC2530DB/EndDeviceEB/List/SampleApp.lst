###############################################################################
#
# IAR C/C++ Compiler V10.30.1.6000 for 8051               04/Sep/2021  09:23:49
# Copyright 2004-2018 IAR Systems AB.
# PC-locked license - IAR Embedded Workbench for 8051
#
#    Core               =  plain
#    Code model         =  banked
#    Data model         =  large
#    Calling convention =  xdata reentrant
#    Constant location  =  data_rom
#    Dptr setup         =  1,16
#                          
#    Source file        =  
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c
#    Command line       =  
#        -f C:\Users\OY\AppData\Local\Temp\EW7A10.tmp
#        (C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c
#        -D NWK_AUTO_POLL -D ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC -D MT_ZDO_FUNC
#        -D LCD_SUPPORTED=DEBUG -lC
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\EndDeviceEB\List
#        -lA
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\EndDeviceEB\List
#        --diag_suppress Pe001,Pa010 -o
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\EndDeviceEB\Obj
#        -e --debug --core=plain --dptr=16,1 --data_model=large
#        --code_model=banked --calling_convention=xdata_reentrant
#        --place_constants=data_rom --nr_virtual_regs 8 -f
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg
#        (-DCPU32MHZ -DROOT=__near_func -DMAC_CFG_TX_DATA_MAX=3
#        -DMAC_CFG_TX_MAX=6 -DMAC_CFG_RX_MAX=3) -f
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg
#        (-DZIGBEEPRO -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR
#        -DDEFAULT_CHANLIST=0x00000800 -DZDAPP_CONFIG_PAN_ID=0xFFF1
#        -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MASK=0x007F
#        -DBEACON_REQUEST_DELAY=100 -DBEACON_REQ_DELAY_MASK=0x00FF
#        -DLINK_STATUS_JITTER_MASK=0x007F -DROUTE_EXPIRY_TIME=30
#        -DAPSC_ACK_WAIT_DURATION_POLLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7
#        -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3
#        -DNWK_MAX_DATA_RETRIES=2 -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9
#        -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40 -DNWK_MAX_BINDING_ENTRIES=4
#        -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01, 0x03, 0x05, 0x07,
#        0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C,
#        0x0D}" -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=20
#        "-DCONST=const __code" -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE
#        -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100
#        -DREJOIN_POLL_RATE=440) -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\Source\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\ZMain\TI2530DB\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\hal\include\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\hal\target\CC2530EB\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\mac\include\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\mac\high_level\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\single_chip\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\mt\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\osal\include\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\services\saddr\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\services\sdata\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\af\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\nwk\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\sapi\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\sec\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\sys\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\stack\zdo\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\zmac\
#        -I
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\Components\zmac\f8w\
#        -Ohz --no_code_motion)
#    Locale             =  Chinese (Simplified)_CHN.936
#    List file          =  
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\EndDeviceEB\List\SampleApp.lst
#    Object file        =  
#        C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\CC2530DB\EndDeviceEB\Obj\SampleApp.r51
#
###############################################################################

C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c
      1          /*********************************************************************
      2           * INCLUDES
      3           */
      4          
      5          #include <stdio.h>
      6          #include <string.h>
      7          #include "AF.h"
      8          #include "OnBoard.h"

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1
      9          #include "OSAL_Tasks.h"
     10          #include "SampleApp.h"
     11          #include "ZDApp.h"
     12          #include "ZDObject.h"
     13          #include "ZDProfile.h"
     14          
     15          #include "hal_drivers.h"
     16          #include "hal_key.h"
     17          #if defined ( LCD_SUPPORTED )
     18            #include "hal_lcd.h"
     19          #endif
     20          #include "hal_led.h"
     21          #include "hal_uart.h"
     22          
     23          #ifdef ZDO_COORDINATOR
     24          //协议文件
     25          #include "mqtt.h"
     26          #include "mqttkit.h"
     27          
     28          #else
     29          
     30          #include "dht11.h"
     31          
     32          #endif
     33          
     34          
     35          /*********************************************************************
     36           * MACROS
     37           */
     38          
     39          /*********************************************************************
     40           * CONSTANTS
     41           */
     42          
     43          #if !defined( SAMPLE_APP_PORT )
     44          #define SAMPLE_APP_PORT  0
     45          #endif
     46          
     47          #if !defined( SAMPLE_APP_RX_MAX )
     48          #define SAMPLE_APP_RX_MAX  200
     49          #endif
     50          
     51          
     52          // This list should be filled with Application specific Cluster IDs.

   \                                 In  segment XDATA_ROM_C, align 1
     53          const cId_t SampleApp_ClusterList[SAMPLE_MAX_CLUSTERS] =
   \                     SampleApp_ClusterList:
   \   000000   0100         DW 1
   \   000002   0200         DW 2
   \   000004   0300         DW 3
   \   000006   0400         DW 4
     54              {
     55                  SAMPLEAPP_P2P_CLUSTERID,
     56                  SAMPLEAPP_PERIODIC_CLUSTERID,
     57                  SERIALAPP_CONNECTREQ_CLUSTER,
     58                  SAMPLEAPP_CTE_CLUSTERID // coor to end
     59          };
     60          

   \                                 In  segment XDATA_ROM_C, align 1
     61          const SimpleDescriptionFormat_t SampleApp_SimpleDesc =
   \                     SampleApp_SimpleDesc:
   \   000000   0B           DB 11
   \   000001   050F         DW 3845
   \   000003   0100         DW 1
   \   000005   00           DB 0
   \   000006   04           DB 4
   \   000007   ....         DW SampleApp_ClusterList
   \   000009   04           DB 4
   \   00000A   ....         DW SampleApp_ClusterList
     62          {
     63            SAMPLEAPP_ENDPOINT,              //  int   Endpoint;
     64            SAMPLEAPP_PROFID,                //  uint16 AppProfId[2];
     65            SAMPLEAPP_DEVICEID,              //  uint16 AppDeviceId[2];
     66            SAMPLEAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
     67            SAMPLEAPP_FLAGS,                 //  int   AppFlags:4;
     68            SAMPLE_MAX_CLUSTERS,          //  byte  AppNumInClusters;
     69            (cId_t *)SampleApp_ClusterList,  //  byte *pAppInClusterList;
     70            SAMPLE_MAX_CLUSTERS,          //  byte  AppNumOutClusters;
     71            (cId_t *)SampleApp_ClusterList   //  byte *pAppOutClusterList;
     72          };
     73          

   \                                 In  segment XDATA_I, align 1, keep-with-next
     74          endPointDesc_t SampleApp_epDesc =
   \                     SampleApp_epDesc:
   \   000000                DS 6
   \   000006                REQUIRE `?<Initializer for SampleApp_epDesc>`
   \   000006                REQUIRE __INIT_XDATA_I
     75          {
     76            SAMPLEAPP_ENDPOINT,
     77           &SampleApp_TaskID,
     78            (SimpleDescriptionFormat_t *)&SampleApp_SimpleDesc,
     79            noLatencyReqs
     80          };
     81          
     82          /*********************************************************************
     83           * TYPEDEFS
     84           */
     85          
     86          /*********************************************************************
     87           * GLOBAL VARIABLES
     88           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     89          devStates_t SampleApp_NwkState;
   \                     SampleApp_NwkState:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     90          uint8 SampleApp_TaskID;           // Task ID for internal task/event processing.
   \                     SampleApp_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
     91          
     92          /*********************************************************************
     93           * EXTERNAL VARIABLES
     94           */
     95          
     96          /*********************************************************************
     97           * EXTERNAL FUNCTIONS
     98           */
     99          
    100          /*********************************************************************
    101           * LOCAL VARIABLES
    102           */
    103          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    104          static uint8 SampleApp_MsgID; //消息id
   \                     SampleApp_MsgID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    105          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    106          afAddrType_t SampleApp_P2P_DstAddr; //播类型
   \                     SampleApp_P2P_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z
    107          
    108          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    109          static uint8 SampleApp_RxBuf[SAMPLE_APP_RX_MAX+1]={0};
   \                     SampleApp_RxBuf:
   \   000000                DS 201
   \   0000C9                REQUIRE __INIT_XDATA_Z
    110          static uint16 SampleApp_RxLen=0;
    111          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    112          uint8 onenet_login_ok=0;//onenet注册成功 0:未注册，1：注册中　2：注册成功
   \                     onenet_login_ok:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    113          uint8 end_temp;//终端的温度
   \                     end_temp:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    114          uint8 end_hum;//终端的湿度
   \                     end_hum:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    115          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    116          uint8 end_light = 0;       //开发板区域亮度     亮0-127灭
   \                     end_light:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    117          uint8 end_led3 = 0;        //终端节点开发板led3状态     0灭 1亮
   \                     end_led3:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    118          uint8 cor_led3 = 0;        //协调器led3 0灭 1亮
   \                     cor_led3:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    119          #ifdef ZDO_COORDINATOR
    120          signed char *g_mqtt_topics_set[5] = {NULL};
    121          u8 topics_buff[60]={0};
    122          u8 topics_post[100]={0}; //发布的主题
    123          u8 mqtt_message[200]={0};//发布的消息
    124          #endif
    125          
    126          /*********************************************************************
    127           * LOCAL FUNCTIONS
    128           */
    129          
    130          static void SampleApp_ProcessMSGCmd( afIncomingMSGPacket_t *pkt );
    131          void SampleApp_CallBack(uint8 port, uint8 event);
    132          static void SampleApp_Send_P2P_Message( void );
    133          static void OneNet_publish_topic();
    134          void debug(uint8 * msg, ...);
    135          
    136          /*********************************************************************
    137           * @fn      SampleApp_Init
    138           *
    139           * @brief   This is called during OSAL tasks' initialization.
    140           *
    141           * @param   task_id - the Task ID assigned by OSAL.
    142           *
    143           * @return  none
    144           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    145          void SampleApp_Init( uint8 task_id )
   \                     SampleApp_Init:
    146          {
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   \   000006   FE           MOV       R6,A
    147            halUARTCfg_t uartConfig;
    148          
    149            SampleApp_TaskID = task_id;
   \   000007   90....       MOV       DPTR,#SampleApp_TaskID
   \   00000A   F0           MOVX      @DPTR,A
    150            SampleApp_NwkState = DEV_INIT;
   \   00000B   90....       MOV       DPTR,#SampleApp_NwkState
   \   00000E   7401         MOV       A,#0x1
   \   000010   F0           MOVX      @DPTR,A
    151          
    152            MT_UartInit();                  //串口初始化
                   ^
Warning[Pe223]: function "MT_UartInit" declared implicitly
   \   000011                ; Setup parameters for call to function MT_UartInit
   \   000011   12....       LCALL     `??MT_UartInit::?relay`; Banked call to: MT_UartInit
    153            MT_UartRegisterTaskID(task_id); //注册串口任务
                   ^
Warning[Pe223]: function "MT_UartRegisterTaskID" declared implicitly
   \   000014                ; Setup parameters for call to function MT_UartRegisterTaskID
   \   000014   EE           MOV       A,R6
   \   000015   FA           MOV       R2,A
   \   000016   7B00         MOV       R3,#0x0
   \   000018   12....       LCALL     `??MT_UartRegisterTaskID::?relay`; Banked call to: MT_UartRegisterTaskID
    154            afRegister( (endPointDesc_t *)&SampleApp_epDesc );
   \   00001B                ; Setup parameters for call to function afRegister
   \   00001B   7A..         MOV       R2,#SampleApp_epDesc & 0xff
   \   00001D   7B..         MOV       R3,#(SampleApp_epDesc >> 8) & 0xff
   \   00001F   12....       LCALL     `??afRegister::?relay`; Banked call to: afRegister
    155            RegisterForKeys( task_id );
   \   000022                ; Setup parameters for call to function RegisterForKeys
   \   000022   EE           MOV       A,R6
   \   000023   F9           MOV       R1,A
   \   000024   12....       LCALL     `??RegisterForKeys::?relay`; Banked call to: RegisterForKeys
    156          
    157          #ifdef ZDO_COORDINATOR
    158            //协调器初始化
    159          
    160            //逢蜂鸣器初始化
    161          
    162            //  P0SEL &= ~0x80;                 //设置P07为普通IO口
    163            //  P0DIR |= 0x80;                 //P07定义为输出口
    164            //
    165            //  //默认蜂鸣器不响
    166            //  P0_7=1;
    167          
    168            //初始化发布的主题
    169            sprintf(topics_post, "/post");//"/sys/%s/%s/thing/event/property/post",ProductKey,DeviceName);
    170          
    171            //初始化订阅的主题
    172            sprintf(topics_buff, "/set");//"/sys/%s/%s/thing/service/property/set",ProductKey,DeviceName);// /sys/a1sYYwS4kmH/mytestdev/thing/service/property/set
    173            g_mqtt_topics_set[0]=topics_buff;
    174          
    175            //协调器广播给终端
    176            SampleApp_P2P_DstAddr.addrMode = (afAddrMode_t)AddrBroadcast; //广播模式
    177            SampleApp_P2P_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
    178            SampleApp_P2P_DstAddr.addr.shortAddr = 0xFFFF; //发给终端
    179          
    180            //目的地址端口号
    181            endPointDesc_t SampleApp_epDesc;
    182            SampleApp_epDesc.endPoint = SAMPLEAPP_ENDPOINT;
    183            SampleApp_epDesc.task_id = &SampleApp_TaskID;
    184            SampleApp_epDesc.simpleDesc = (SimpleDescriptionFormat_t *)&SampleApp_SimpleDesc;
    185            SampleApp_epDesc.latencyReq = noLatencyReqs;
    186            afRegister(&SampleApp_epDesc);
    187          
    188          #else
    189            //终端点播给协调器
    190            SampleApp_P2P_DstAddr.addrMode = (afAddrMode_t)Addr16Bit; //点播
   \   000027   90....       MOV       DPTR,#SampleApp_P2P_DstAddr + 8
   \   00002A   7402         MOV       A,#0x2
   \   00002C   F0           MOVX      @DPTR,A
    191            SampleApp_P2P_DstAddr.endPoint = SAMPLEAPP_ENDPOINT;
   \   00002D   A3           INC       DPTR
   \   00002E   740B         MOV       A,#0xb
   \   000030   F0           MOVX      @DPTR,A
    192            SampleApp_P2P_DstAddr.addr.shortAddr = 0x0000;            //发给协调器
   \   000031   90....       MOV       DPTR,#SampleApp_P2P_DstAddr
   \   000034   E4           CLR       A
   \   000035   F0           MOVX      @DPTR,A
   \   000036   A3           INC       DPTR
   \   000037   F0           MOVX      @DPTR,A
    193          
    194          
    195          #endif
    196          }
   \   000038   7F01         MOV       R7,#0x1
   \   00003A   02....       LJMP      ?BANKED_LEAVE_XDATA
    197          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    198          void SampleApp_HandleKeys( uint8 shift, uint8 keys )
   \                     SampleApp_HandleKeys:
    199          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    200            (void)shift;  // Intentionally unreferenced parameter
    201          
    202          #if defined(ZDO_COORDINATOR)
    203          
    204            if ( keys & HAL_KEY_SW_6 )//key1
    205            {
    206              const signed char *g_mqtt_topics[] = {"mqtt_topic_test1"};
    207              if(0 == mqtt_subscribe_topic(g_mqtt_topics, 1))
    208              {
    209          
    210              }
    211            }
    212          
    213            if ( keys & HAL_KEY_SW_1 )//key2
    214            {
    215          
    216            }
    217          
    218          #endif
    219          }
   \   000000   02....       LJMP      ?BRET
    220          
    221          
    222          /*********************************************************************
    223           * @fn      SampleApp_ProcessEvent
    224           *
    225           * @brief   Generic Application Task event processor.
    226           *
    227           * @param   task_id  - The OSAL assigned task ID.
    228           * @param   events   - Bit map of events to process.
    229           *
    230           * @return  Event flags of all unprocessed events.
    231           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    232          UINT16 SampleApp_ProcessEvent( uint8 task_id, UINT16 events )
   \                     SampleApp_ProcessEvent:
    233          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000   74F2         MOV       A,#-0xe
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 128
   \   000005   7480         MOV       A,#-0x80
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
    234            (void)task_id;  // Intentionally unreferenced parameter
    235          
    236            if ( events & SYS_EVENT_MSG )
   \   00000E   5480         ANL       A,#0x80
   \   000010   7055         JNZ       ??SampleApp_ProcessEvent_0
    237            {
    238              afIncomingMSGPacket_t *MSGpkt;
    239          
    240              while ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID )) )
    241              {
    242                switch ( MSGpkt->hdr.event )
    243                {
    244                case KEY_CHANGE:
    245                  SampleApp_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    246                  break;
    247          
    248                case AF_INCOMING_MSG_CMD:
    249                  SampleApp_ProcessMSGCmd( MSGpkt );
    250                  break;
    251          
    252                case ZDO_STATE_CHANGE:
    253                  SampleApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
    254                  if ( (SampleApp_NwkState == DEV_ZB_COORD)||
    255                      (SampleApp_NwkState == DEV_ROUTER)
    256                      || (SampleApp_NwkState == DEV_END_DEVICE) )
    257                  {
    258                      //连网成功后，启动一个定时器
    259                      osal_start_timerEx( SampleApp_TaskID,
    260                                        SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    261                                        SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT );
    262                  }
    263                  else
    264                  {
    265                    // Device is no longer in the network
    266                  }
    267                  break;
    268          
    269                default:
    270                  break;
    271                }
    272          
    273                osal_msg_deallocate( (uint8 *)MSGpkt );
    274              }
    275          
    276              return ( events ^ SYS_EVENT_MSG );
    277            }
    278          
    279          #ifdef ZDO_COORDINATOR
    280          
    281            //定时器时间到
    282            if ( events & SAMPLEAPP_SEND_PERIODIC_MSG_EVT )
    283            {
    284              if(onenet_login_ok==2)
    285              {
    286                  //如果接入onenet成功，启动心跳和发送数据定A器
    287          
    288                  P1_1=0;//点亮D2
    289          
    290          
    291                  // 启动心跳定时器，15秒一次
    292                  osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_ONENET_HEART_BEAT_EVT,15000 );
    293          
    294                  // 启动发送数据定时器，5秒一次
    295                  osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_ONENET_SEND_DATA_EVT,5000 );
    296              }
    297              else
    298              {
    299                  onenet_login_ok=1;//onenet注册成功 0:未注册，1：注册中　2：注册成功
    300                  SampleApp_RxLen=0;
    301          
    302                  //如果没有接入onenet成功，重新发起接入
    303                  OneNet_DevLink();//接入onenet服务器
    304          
    305                  //LED2闪，表示正在接入onenet
    306                  HalLedBlink (HAL_LED_2, 5, 50, 500);
    307          
    308                  // 每5秒尝试接入一次
    309                  osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_SEND_PERIODIC_MSG_EVT,5000 );
    310              }
    311          
    312          
    313              // return unprocessed events
    314              return (events ^ SAMPLEAPP_SEND_PERIODIC_MSG_EVT);
    315            }
    316          
    317          
    318            //心跳定时器时间到
    319            if ( events & SAMPLEAPP_ONENET_HEART_BEAT_EVT )
    320            {
    321              if(onenet_login_ok==2)
    322              {
    323                  //发送心跳
    324                  onenet_mqtt_send_heart();
    325              }
    326          
    327              // 启动心跳定时器，15秒一次
    328              osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_ONENET_HEART_BEAT_EVT,15000 );
    329          
    330          
    331              // return unprocessed events
    332              return (events ^ SAMPLEAPP_ONENET_HEART_BEAT_EVT);
    333            }
    334          
    335          
    336            //发送数据定时器时间到
    337            if ( events & SAMPLEAPP_ONENET_SEND_DATA_EVT )
    338            {
    339              if(onenet_login_ok==2)
    340              {
    341                  //发送温湿度数据到onenet
    342              //    OneNet_SendData(end_temp, end_hum);
    343          
    344                  sprintf(mqtt_message,
    345                  "{\"method\":\"thing.service.property.set\",\"id\":\"630262306\",\"params\":{\
    346                      \"temp\":%d,\
    347                      \"hum\":%d,\
    348                         \"end_light\":%d,\
    349                        \"led3\":%d}\
    350                  }",
    351                  end_temp,
    352                  end_hum,
    353                  end_light,
    354                  cor_led3
    355                  );
    356          
    357                  //发布主题
    358                  mqtt_publish_topic(topics_post, mqtt_message);
    359          
    360               //  OneNet_publish_topic();
    361              }
    362          
    363              // 启动发送数据定时器，5秒一次
    364              osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_ONENET_SEND_DATA_EVT,5000 );
    365          
    366          
    367              // return unprocessed events
    368              return (events ^ SAMPLEAPP_ONENET_SEND_DATA_EVT);
    369            }
    370          
    371          
    372          #else
    373          
    374            //定时器时间到
    375            if ( events & SAMPLEAPP_SEND_PERIODIC_MSG_EVT )
   \   000012   EA           MOV       A,R2
   \   000013   A2E0         MOV       C,0xE0 /* A   */.0
   \   000015   4003         JC        $+5
   \   000017   02....       LJMP      ??SampleApp_ProcessEvent_1 & 0xFFFF
    376            {
    377          
    378              // DHT11采集
    379              SampleApp_Send_P2P_Message();
   \   00001A                ; Setup parameters for call to function SampleApp_Send_P2P_Message
   \   00001A   12....       LCALL     `??SampleApp_Send_P2P_Message::?relay`; Banked call to: SampleApp_Send_P2P_Message
    380          
    381              // Setup to send message again in normal period (+ a little jitter)
    382              osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
    383                  (SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT + (osal_rand() & 0x00FF)) );
   \   00001D                ; Setup parameters for call to function osal_rand
   \   00001D   12....       LCALL     `??osal_rand::?relay`; Banked call to: osal_rand
   \   000020                ; Setup parameters for call to function osal_start_timerEx
   \   000020   EA           MOV       A,R2
   \   000021   24B8         ADD       A,#-0x48
   \   000023   FC           MOV       R4,A
   \   000024   E4           CLR       A
   \   000025   340B         ADDC      A,#0xb
   \   000027   FD           MOV       R5,A
   \   000028   7A01         MOV       R2,#0x1
   \   00002A   7B00         MOV       R3,#0x0
   \   00002C   90....       MOV       DPTR,#SampleApp_TaskID
   \   00002F   E0           MOVX      A,@DPTR
   \   000030   F9           MOV       R1,A
   \   000031   12....       LCALL     `??osal_start_timerEx::?relay`; Banked call to: osal_start_timerEx
    384          
    385              // return unprocessed events
    386              return (events ^ SAMPLEAPP_SEND_PERIODIC_MSG_EVT);
   \   000034   EE           MOV       A,R6
   \   000035   6401         XRL       A,#0x1
   \   000037   FA           MOV       R2,A
   \   000038   EF           MOV       A,R7
   \   000039   02....       LJMP      ??SampleApp_ProcessEvent_2 & 0xFFFF
    387            }
   \                     ??SampleApp_ProcessEvent_3:
   \   00003C   A3           INC       DPTR
   \   00003D   E0           MOVX      A,@DPTR
   \   00003E   90....       MOV       DPTR,#SampleApp_NwkState
   \   000041   F0           MOVX      @DPTR,A
   \   000042   6409         XRL       A,#0x9
   \   000044   600A         JZ        ??SampleApp_ProcessEvent_4
   \   000046   E0           MOVX      A,@DPTR
   \   000047   6407         XRL       A,#0x7
   \   000049   6005         JZ        ??SampleApp_ProcessEvent_4
   \   00004B   E0           MOVX      A,@DPTR
   \   00004C   6406         XRL       A,#0x6
   \   00004E   7010         JNZ       ??SampleApp_ProcessEvent_5
   \                     ??SampleApp_ProcessEvent_4:
   \   000050                ; Setup parameters for call to function osal_start_timerEx
   \   000050   7CB8         MOV       R4,#-0x48
   \   000052   7D0B         MOV       R5,#0xb
   \   000054   7A01         MOV       R2,#0x1
   \   000056   7B00         MOV       R3,#0x0
   \   000058   90....       MOV       DPTR,#SampleApp_TaskID
   \   00005B   E0           MOVX      A,@DPTR
   \   00005C   F9           MOV       R1,A
   \   00005D   12....       LCALL     `??osal_start_timerEx::?relay`; Banked call to: osal_start_timerEx
   \                     ??SampleApp_ProcessEvent_5:
   \   000060                ; Setup parameters for call to function osal_msg_deallocate
   \   000060   AA..         MOV       R2,?V4
   \   000062   AB..         MOV       R3,?V5
   \   000064   12....       LCALL     `??osal_msg_deallocate::?relay`; Banked call to: osal_msg_deallocate
   \                     ??SampleApp_ProcessEvent_0:
   \   000067                ; Setup parameters for call to function osal_msg_receive
   \   000067   90....       MOV       DPTR,#SampleApp_TaskID
   \   00006A   E0           MOVX      A,@DPTR
   \   00006B   F9           MOV       R1,A
   \   00006C   12....       LCALL     `??osal_msg_receive::?relay`; Banked call to: osal_msg_receive
   \   00006F   8A..         MOV       ?V4,R2
   \   000071   8B..         MOV       ?V5,R3
   \   000073   EA           MOV       A,R2
   \   000074   4B           ORL       A,R3
   \   000075   6073         JZ        ??SampleApp_ProcessEvent_6
   \   000077   8A82         MOV       DPL,R2
   \   000079   8B83         MOV       DPH,R3
   \   00007B   E0           MOVX      A,@DPTR
   \   00007C   24E6         ADD       A,#-0x1a
   \   00007E   6006         JZ        ??SampleApp_ProcessEvent_7
   \   000080   2449         ADD       A,#0x49
   \   000082   60B8         JZ        ??SampleApp_ProcessEvent_3
   \   000084   80DA         SJMP      ??SampleApp_ProcessEvent_5
   \                     ??SampleApp_ProcessEvent_7:
   \   000086   A3           INC       DPTR
   \   000087   A3           INC       DPTR
   \   000088   A3           INC       DPTR
   \   000089   A3           INC       DPTR
   \   00008A   E0           MOVX      A,@DPTR
   \   00008B   6404         XRL       A,#0x4
   \   00008D   7002         JNZ       ??SampleApp_ProcessEvent_8
   \   00008F   A3           INC       DPTR
   \   000090   E0           MOVX      A,@DPTR
   \                     ??SampleApp_ProcessEvent_8:
   \   000091   70CD         JNZ       ??SampleApp_ProcessEvent_5
   \   000093                ; Setup parameters for call to function osal_memset
   \   000093   7C80         MOV       R4,#-0x80
   \   000095   7D00         MOV       R5,#0x0
   \   000097   7900         MOV       R1,#0x0
   \   000099   AA..         MOV       R2,?XSP + 0
   \   00009B   AB..         MOV       R3,?XSP + 1
   \   00009D   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
   \   0000A0                ; Setup parameters for call to function osal_memcpy
   \   0000A0   E5..         MOV       A,?V4
   \   0000A2   2422         ADD       A,#0x22
   \   0000A4   F582         MOV       DPL,A
   \   0000A6   E4           CLR       A
   \   0000A7   35..         ADDC      A,?V5
   \   0000A9   F583         MOV       DPH,A
   \   0000AB   E0           MOVX      A,@DPTR
   \   0000AC   F5..         MOV       ?V0,A
   \   0000AE   A3           INC       DPTR
   \   0000AF   E0           MOVX      A,@DPTR
   \   0000B0   F5..         MOV       ?V1,A
   \   0000B2   75..00       MOV       ?V2,#0x0
   \   0000B5   78..         MOV       R0,#?V0
   \   0000B7   12....       LCALL     ?PUSH_XSTACK_I_THREE
   \   0000BA   E5..         MOV       A,?V4
   \   0000BC   2420         ADD       A,#0x20
   \   0000BE   F582         MOV       DPL,A
   \   0000C0   E4           CLR       A
   \   0000C1   35..         ADDC      A,?V5
   \   0000C3   F583         MOV       DPH,A
   \   0000C5   E0           MOVX      A,@DPTR
   \   0000C6   FC           MOV       R4,A
   \   0000C7   A3           INC       DPTR
   \   0000C8   E0           MOVX      A,@DPTR
   \   0000C9   FD           MOV       R5,A
   \   0000CA   7403         MOV       A,#0x3
   \   0000CC   12....       LCALL     ?XSTACK_DISP101_8
   \   0000CF   12....       LCALL     `??osal_memcpy::?relay`; Banked call to: osal_memcpy
   \   0000D2   7403         MOV       A,#0x3
   \   0000D4   12....       LCALL     ?DEALLOC_XSTACK8
   \   0000D7                ; Setup parameters for call to function osal_strlen
   \   0000D7   AA..         MOV       R2,?XSP + 0
   \   0000D9   AB..         MOV       R3,?XSP + 1
   \   0000DB   12....       LCALL     ?Subroutine0 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   0000DE                ; Setup parameters for call to function HalUARTWrite
   \   0000DE   AA..         MOV       R2,?XSP + 0
   \   0000E0   AB..         MOV       R3,?XSP + 1
   \   0000E2   7900         MOV       R1,#0x0
   \   0000E4   12....       LCALL     `??HalUARTWrite::?relay`; Banked call to: HalUARTWrite
   \   0000E7   02....       LJMP      ??SampleApp_ProcessEvent_5 & 0xFFFF
   \                     ??SampleApp_ProcessEvent_6:
   \   0000EA   EE           MOV       A,R6
   \   0000EB   FA           MOV       R2,A
   \   0000EC   EF           MOV       A,R7
   \   0000ED   6480         XRL       A,#0x80
   \                     ??SampleApp_ProcessEvent_2:
   \   0000EF   FB           MOV       R3,A
   \   0000F0   8004         SJMP      ??SampleApp_ProcessEvent_9
    388          
    389          #endif
    390          
    391            return ( 0 );  // Discard unknown events.
   \                     ??SampleApp_ProcessEvent_1:
   \   0000F2   7A00         MOV       R2,#0x0
   \   0000F4   7B00         MOV       R3,#0x0
   \                     ??SampleApp_ProcessEvent_9:
   \   0000F6   7480         MOV       A,#-0x80
   \   0000F8   12....       LCALL     ?DEALLOC_XSTACK8
   \   0000FB   7F06         MOV       R7,#0x6
   \   0000FD   02....       LJMP      ?BANKED_LEAVE_XDATA
    392          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   12....       LCALL     `??osal_strlen::?relay`; Banked call to: osal_strlen
   \   000003   8A..         MOV       ?V0,R2
   \   000005   8B..         MOV       ?V1,R3
   \   000007   AC..         MOV       R4,?V0
   \   000009   AD..         MOV       R5,?V1
   \   00000B   22           RET
    393          
    394          /*********************************************************************
    395           * @fn      SerialApp_ProcessMSGCmd
    396           *
    397           * @brief   Data message processor callback. This function processes
    398           *          any incoming data - probably from other devices. Based
    399           *          on the cluster ID, perform the intended action.
    400           *
    401           * @param   pkt - pointer to the incoming message packet
    402           *
    403           * @return  TRUE if the 'pkt' parameter is being used and will be freed later,
    404           *          FALSE otherwise.
    405           */
    406          void SampleApp_ProcessMSGCmd( afIncomingMSGPacket_t *pkt )
    407          {
    408            uint8 buff[20]={0};
    409          
    410            switch ( pkt->clusterId )
    411            {
    412            // 接收终端上传的温度数据
    413            case SAMPLEAPP_P2P_CLUSTERID:
    414          #ifdef ZDO_COORDINATOR
    415              {
    416                  end_temp=pkt->cmd.Data[0]; //终端温度
    417                  end_hum=pkt->cmd.Data[1]; //终端湿度
    418          
    419                  end_light = pkt->cmd.Data[2]; //终端亮度
    420                  cor_led3 = P1_4; //终端LED3状态
    421                  cor_led3 = !cor_led3;
    422                  sprintf(buff, "T:%d", end_temp);
    423                  HalLcdWriteString(buff, HAL_LCD_LINE_3); //LCD显示
    424          
    425                  sprintf(buff, "H:%d", end_hum);
    426                  HalLcdWriteString(buff, HAL_LCD_LINE_4); //LCD显示
    427              }
    428          #endif
    429              break;
    430          
    431            case SAMPLEAPP_PERIODIC_CLUSTERID:
    432          
    433              break;
    434            case SAMPLEAPP_CTE_CLUSTERID: //coor to end 终端进行命令解析和处理
    435              char buf[128];
                     ^
Warning[Pe1072]: a declaration cannot have a label
    436              osal_memset(buf, '\0', 128);
    437              osal_memcpy(buf, pkt->cmd.Data, pkt->cmd.DataLength); //复制到缓冲区
    438              HalUARTWrite(0, buf, osal_strlen(buf));               //串口输出提示信息
                                     ^
Warning[Pe167]: argument of type "char *" is incompatible with parameter of
          type "uint8 *"

    uint8 buff[20]={0};
          ^
"C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c",408  Warning[Pe177]: 
          variable "buff" was declared but never referenced
    439          
    440              default:
    441                break;
    442            }
    443          }
    444          
    445          #ifdef ZDO_COORDINATOR
    446          
    447          //发送MQTT数据
    448          void ESP8266_SendData(char* buff, int len)
    449          {
    450              if(len==0) return;
    451          
    452              HalUARTWrite(0,buff, len);
    453          }
    454          
    455          
    456          //接收到下发命令，或者接收到订阅的消息
    457          //topic:收到的主题
    458          //cmd::主题对应的内容
    459          void mqtt_rx(uint8* topic, uint8* cmd)
    460          {
    461              char *ptr_led3_on = NULL;
    462              char *ptr_led3_off = NULL;
    463            
    464              char *this_topic = NULL;
    465              //协调器收到数据后
    466              //根据设计决定数据如何处理
    467          
    468              if(topic == NULL || cmd==NULL) return;
    469              
    470              //我们只关心内容，即只关心CMD，不处理主题
    471          
    472              ptr_led3_on = strstr((char *)cmd, "\"led\":1");
    473              ptr_led3_off = strstr((char *)cmd, "\"led\":0");
    474          
    475              if(ptr_led3_on!=NULL)
    476              {
    477                P1_4=0;//D3亮
    478                cor_led3 = 1;
    479              }
    480              else if(ptr_led3_off!=NULL)
    481              {
    482                P1_4=1;//D3灭
    483                cor_led3 = 0;
    484              }
    485              HalLedBlink (HAL_LED_1, 5, 50, 500);
    486            
    487          AF_DataRequest(&SampleApp_P2P_DstAddr,  //&Endevice_Add,  //目的节点网络地址和发送格式
    488                           &SampleApp_epDesc,       //目的地址端口号
    489                           SAMPLEAPP_CTE_CLUSTERID, //命令号，用于区别命令 coor to end
    490                           osal_strlen(uartbuf),    //发送数据的长度
    491                           uartbuf,                 //发送数据的缓冲区
    492                           &SampleApp_MsgID,        //发送序号,发完+1
    493                           AF_DISCV_ROUTE,
    494                           AF_DEFAULT_RADIUS);
    495          }
    496          
    497          
    498          
    499          void OneNet_publish_topic()
    500          {
    501              uint8 buff[20]={0};
    502          
    503              sprintf(buff, "t:%d,h:%d", end_temp, end_hum);
    504          
    505              /*  发布主题为"hello_topic_public"，消息为温度和湿度 */
    506              if(0 == mqtt_publish_topic("hello_topic_public", buff))
    507              {;}
    508          }
    509          
    510          
    511          
    512          /*********************************************************************
    513           * @fn      SampleApp_CallBack
    514           *
    515           * @brief   Send data OTA.
    516           *
    517           * @param   port - UART port.
    518           * @param   event - the UART port event flag.
    519           *
    520           * @return  none
    521           */
    522          uint32 lastReadMs=0;
    523          void SampleApp_CallBack(uint8 port, uint8 event)
    524          {
    525            (void)port;
    526          
    527            if(0==onenet_login_ok)
    528            {
    529              HalUARTRead(SAMPLE_APP_PORT, SampleApp_RxBuf, SAMPLE_APP_RX_MAX);
    530              SampleApp_RxLen=0;
    531              osal_memset(SampleApp_RxBuf, 0, SAMPLE_APP_RX_MAX);
    532            }
    533            else if(1==onenet_login_ok)//onenet注册成功 0:未注册，1：注册中　2：注册成功
    534            {
    535              //一个一个字节读
    536              SampleApp_RxLen += HalUARTRead(SAMPLE_APP_PORT, SampleApp_RxBuf+SampleApp_RxLen, 4);
    537          
    538              //判断是否是注册成功
    539              if(SampleApp_RxLen>=4)
    540              {
    541          //        debug("rx len=%d(%x,%x,%x,%x)\r\n", SampleApp_RxLen,SampleApp_RxBuf[0],SampleApp_RxBuf[1],SampleApp_RxBuf[2],SampleApp_RxBuf[3]);
    542          
    543                  //等待接入响应
    544                  if(MQTT_UnPacketRecv(SampleApp_RxBuf) == MQTT_PKT_CONNACK)
    545                  {
    546                      if(0==MQTT_UnPacketConnectAck(SampleApp_RxBuf))
    547                      {
    548                          onenet_login_ok=2;//注册成功
    549                          SampleApp_RxLen=0;
    550          
    551                          //请求订阅主题
    552                          if(mqtt_subscribe_topic(g_mqtt_topics_set, 1) == 0)
    553                          {
    554                            //订阅成功P1_4  D3变为亮
    555                            P1_4 = 0;
    556                          }
    557          
    558                      }
    559                  }
    560              }
    561          
    562              //数组满，清0
    563              if(SampleApp_RxLen>=SAMPLE_APP_RX_MAX)
    564              {
    565                  SampleApp_RxLen=0;
    566              }
    567            }
    568            else if(2==onenet_login_ok)
    569            {
    570                //如果是注册成功，读服务器的控制命令
    571          
    572                uint32 curMs=osal_GetSystemClock();
    573          
    574                if((curMs-lastReadMs)<1000) return;
    575          
    576                lastReadMs=curMs;
    577                SampleApp_RxLen=0;
    578                osal_memset(SampleApp_RxBuf, 0, SAMPLE_APP_RX_MAX+1);
    579                SampleApp_RxLen = HalUARTRead(SAMPLE_APP_PORT, SampleApp_RxBuf, SAMPLE_APP_RX_MAX); //读长200的数据
    580          
    581          
    582          
    583                if(SampleApp_RxLen>0)
    584                {
    585                  debug("rx len=%d.\r\n", SampleApp_RxLen);
    586                  //接收消息
    587                  OneNet_RevPro(SampleApp_RxBuf); 
    588                  //debug LED3 
    589          //        HalLedBlink (HAL_LED_3, 5, 50, 500); //HalLedSet
    590                  SampleApp_RxLen=0;
    591                  osal_memset(SampleApp_RxBuf, 0, SAMPLE_APP_RX_MAX+1);
    592                }
    593            }
    594          
    595          }
    596          
    597          #else
    598          #include "hal_ADC.h"
    599          /*********************************************************************
    600           * @fn      SampleApp_Send_P2P_Message
    601           *
    602           * @brief   point to point.
    603           *
    604           * @param   none
    605           *
    606           * @return  none
    607           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    608          void SampleApp_Send_P2P_Message( void )
   \                     SampleApp_Send_P2P_Message:
    609          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 25
   \   000005   74E7         MOV       A,#-0x19
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
    610            uint8 str[5]={0};
   \   00000A   90....       MOV       DPTR,#`?<Constant {0, 0, 0, 0, 0}>`
   \   00000D   AC..         MOV       R4,?XSP + 0
   \   00000F   AD..         MOV       R5,?XSP + 1
   \   000011   7405         MOV       A,#0x5
   \   000013   12....       LCALL     ?MOVE_LONG8_XDATA_XDATA
    611            uint8 strTemp[20]={0};
   \   000016   90....       MOV       DPTR,#`?<Constant {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0`
   \   000019   7405         MOV       A,#0x5
   \   00001B   12....       LCALL     ?XSTACK_DISP102_8
   \   00001E   7414         MOV       A,#0x14
   \   000020   12....       LCALL     ?MOVE_LONG8_XDATA_XDATA
    612            int len=0;
    613            
    614            osal_memset(str,'\0',5);
   \   000023                ; Setup parameters for call to function osal_memset
   \   000023   7C05         MOV       R4,#0x5
   \   000025   FD           MOV       R5,A
   \   000026   F9           MOV       R1,A
   \   000027   AA..         MOV       R2,?XSP + 0
   \   000029   AB..         MOV       R3,?XSP + 1
   \   00002B   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
    615            osal_memset(strTemp,'\0',20);
   \   00002E                ; Setup parameters for call to function osal_memset
   \   00002E   7C14         MOV       R4,#0x14
   \   000030   7D00         MOV       R5,#0x0
   \   000032   7900         MOV       R1,#0x0
   \   000034   7405         MOV       A,#0x5
   \   000036   12....       LCALL     ?XSTACK_DISP101_8
   \   000039   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
    616            
    617            DHT11();             //获取温湿度
   \   00003C                ; Setup parameters for call to function DHT11
   \   00003C   12....       LCALL     `??DHT11::?relay`; Banked call to: DHT11
    618            
    619            HalAdcInit();
   \   00003F                ; Setup parameters for call to function HalAdcInit
   \   00003F   12....       LCALL     `??HalAdcInit::?relay`; Banked call to: HalAdcInit
    620            uint8 end_light_temp = HalAdcRead(HAL_ADC_CHANNEL_6,HAL_ADC_RESOLUTION_8);
   \   000042                ; Setup parameters for call to function HalAdcRead
   \   000042   7A01         MOV       R2,#0x1
   \   000044   7906         MOV       R1,#0x6
   \   000046   12....       LCALL     `??HalAdcRead::?relay`; Banked call to: HalAdcRead
   \   000049   8A..         MOV       ?V0,R2
    621            uint8 end_led3_temp = 0;
    622            
    623            if(P1_4 == 1) 
   \   00004B   AA90         MOV       R2,0x90+0x0
    624              end_led3_temp = 0;
    625            else 
    626              end_led3_temp = 1;
    627            
    628            str[0] = wendu;//温度
   \   00004D   90....       MOV       DPTR,#wendu
   \   000050   E0           MOVX      A,@DPTR
   \   000051   85..82       MOV       DPL,?XSP + 0
   \   000054   85..83       MOV       DPH,?XSP + 1
   \   000057   F0           MOVX      @DPTR,A
    629            str[1] = shidu;//湿度
   \   000058   90....       MOV       DPTR,#shidu
   \   00005B   E0           MOVX      A,@DPTR
   \   00005C   C0E0         PUSH      A
   \   00005E   7401         MOV       A,#0x1
   \   000060   12....       LCALL     ?XSTACK_DISP0_8
   \   000063   D0E0         POP       A
   \   000065   F0           MOVX      @DPTR,A
    630            
    631            str[2] = end_light_temp;//亮度
   \   000066   7402         MOV       A,#0x2
   \   000068   12....       LCALL     ?XSTACK_DISP0_8
   \   00006B   E5..         MOV       A,?V0
   \   00006D   F0           MOVX      @DPTR,A
    632            str[3] = end_led3_temp; //led3状态
   \   00006E   EA           MOV       A,R2
   \   00006F   A2E4         MOV       C,0xE0 /* A   */.4
   \   000071   4004         JC        ??SampleApp_Send_P2P_Message_0
   \   000073   D2F0         SETB      B.0
   \   000075   8002         SJMP      ??SampleApp_Send_P2P_Message_1
   \                     ??SampleApp_Send_P2P_Message_0:
   \   000077   C2F0         CLR       B.0
   \                     ??SampleApp_Send_P2P_Message_1:
   \   000079   A2F0         MOV       C,B.0
   \   00007B   E4           CLR       A
   \   00007C   33           RLC       A
   \   00007D   C0E0         PUSH      A
   \   00007F   7403         MOV       A,#0x3
   \   000081   12....       LCALL     ?XSTACK_DISP0_8
   \   000084   D0E0         POP       A
   \   000086   F0           MOVX      @DPTR,A
    633            len=4;
    634          
    635            sprintf(strTemp, "T&H:%d %d", str[0],str[1]);
                           ^
Warning[Pe167]: argument of type "uint8 *" is incompatible with parameter of
          type "char *"
   \   000087                ; Setup parameters for call to function sprintf
   \   000087   7401         MOV       A,#0x1
   \   000089   12....       LCALL     ?XSTACK_DISP0_8
   \   00008C   E0           MOVX      A,@DPTR
   \   00008D   F5..         MOV       ?V0,A
   \   00008F   75..00       MOV       ?V1,#0x0
   \   000092   78..         MOV       R0,#?V0
   \   000094   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000097   7402         MOV       A,#0x2
   \   000099   12....       LCALL     ?XSTACK_DISP0_8
   \   00009C   E0           MOVX      A,@DPTR
   \   00009D   F5..         MOV       ?V0,A
   \   00009F   78..         MOV       R0,#?V0
   \   0000A1   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000A4   7C..         MOV       R4,#`?<Constant "T&H:%d %d">` & 0xff
   \   0000A6   7D..         MOV       R5,#(`?<Constant "T&H:%d %d">` >> 8) & 0xff
   \   0000A8   7409         MOV       A,#0x9
   \   0000AA   12....       LCALL     ?XSTACK_DISP101_8
   \   0000AD   12....       LCALL     `??sprintf::?relay`; Banked call to: sprintf
   \   0000B0   7404         MOV       A,#0x4
   \   0000B2   12....       LCALL     ?DEALLOC_XSTACK8
    636            HalLcdWriteString(strTemp, HAL_LCD_LINE_3); //LCD显示
                                     ^
Warning[Pe167]: argument of type "uint8 *" is incompatible with parameter of
          type "char *"
   \   0000B5                ; Setup parameters for call to function HalLcdWriteString
   \   0000B5   7903         MOV       R1,#0x3
   \   0000B7   7405         MOV       A,#0x5
   \   0000B9   12....       LCALL     ?XSTACK_DISP101_8
   \   0000BC   12....       LCALL     `??HalLcdWriteString::?relay`; Banked call to: HalLcdWriteString
    637          
    638            HalUARTWrite(0, strTemp, osal_strlen(strTemp));           //串口输出提示信息
                                                        ^
Warning[Pe167]: argument of type "uint8 *" is incompatible with parameter of
          type "char *"

  static uint16 SampleApp_RxLen=0;
                ^
"C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c",110  Warning[Pe177]: 
          variable "SampleApp_RxLen" was declared but never referenced

  static void OneNet_publish_topic();
              ^
"C:\Users\OY\Desktop\ing\new\ZStack-2.5.1a\Projects\zstack\Samples\SampleApp\Source\SampleApp.c",133  Warning[Pe177]: 
          function "OneNet_publish_topic" was declared but never referenced
   \   0000BF                ; Setup parameters for call to function osal_strlen
   \   0000BF   7405         MOV       A,#0x5
   \   0000C1   12....       LCALL     ?XSTACK_DISP101_8
   \   0000C4   12....       LCALL     ?Subroutine0 & 0xFFFF
   \                     ??CrossCallReturnLabel_0:
   \   0000C7                ; Setup parameters for call to function HalUARTWrite
   \   0000C7   7405         MOV       A,#0x5
   \   0000C9   12....       LCALL     ?XSTACK_DISP101_8
   \   0000CC   7900         MOV       R1,#0x0
   \   0000CE   12....       LCALL     `??HalUARTWrite::?relay`; Banked call to: HalUARTWrite
    639            HalUARTWrite(0, "\r\n",2);
   \   0000D1                ; Setup parameters for call to function HalUARTWrite
   \   0000D1   7C02         MOV       R4,#0x2
   \   0000D3   7D00         MOV       R5,#0x0
   \   0000D5   7A..         MOV       R2,#`?<Constant "\\r\\n">` & 0xff
   \   0000D7   7B..         MOV       R3,#(`?<Constant "\\r\\n">` >> 8) & 0xff
   \   0000D9   7900         MOV       R1,#0x0
   \   0000DB   12....       LCALL     `??HalUARTWrite::?relay`; Banked call to: HalUARTWrite
    640          
    641            //无线发送到协调器
    642            if ( AF_DataRequest( &SampleApp_P2P_DstAddr, &SampleApp_epDesc,
    643                                 SAMPLEAPP_P2P_CLUSTERID,
    644                                 len,
    645                                 str,
    646                                 &SampleApp_MsgID,
    647                                 AF_DISCV_ROUTE,
    648                                 AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
   \   0000DE                ; Setup parameters for call to function AF_DataRequest
   \   0000DE   75..1E       MOV       ?V0,#0x1e
   \   0000E1   78..         MOV       R0,#?V0
   \   0000E3   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   0000E6   75....       MOV       ?V0,#SampleApp_MsgID & 0xff
   \   0000E9   75....       MOV       ?V1,#(SampleApp_MsgID >> 8) & 0xff
   \   0000EC   78..         MOV       R0,#?V0
   \   0000EE   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000F1   7403         MOV       A,#0x3
   \   0000F3   12....       LCALL     ?XSTACK_DISP100_8
   \   0000F6   88..         MOV       ?V0,R0
   \   0000F8   89..         MOV       ?V1,R1
   \   0000FA   78..         MOV       R0,#?V0
   \   0000FC   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000FF   75..04       MOV       ?V0,#0x4
   \   000102   75..00       MOV       ?V1,#0x0
   \   000105   78..         MOV       R0,#?V0
   \   000107   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00010A   75..01       MOV       ?V0,#0x1
   \   00010D   78..         MOV       R0,#?V0
   \   00010F   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000112   7920         MOV       R1,#0x20
   \   000114   7C..         MOV       R4,#SampleApp_epDesc & 0xff
   \   000116   7D..         MOV       R5,#(SampleApp_epDesc >> 8) & 0xff
   \   000118   7A..         MOV       R2,#SampleApp_P2P_DstAddr & 0xff
   \   00011A   7B..         MOV       R3,#(SampleApp_P2P_DstAddr >> 8) & 0xff
   \   00011C   12....       LCALL     `??AF_DataRequest::?relay`; Banked call to: AF_DataRequest
   \   00011F   7409         MOV       A,#0x9
   \   000121   12....       LCALL     ?DEALLOC_XSTACK8
    649            {
    650              
    651            }
    652            else
    653            {
    654              // Error occurred in request to send.
    655            }
    656          }
   \   000124   7419         MOV       A,#0x19
   \   000126   12....       LCALL     ?DEALLOC_XSTACK8
   \   000129   7F02         MOV       R7,#0x2
   \   00012B   02....       LJMP      ?BANKED_LEAVE_XDATA
   \   00012E                REQUIRE _A_P1
    657          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    658          void SampleApp_CallBack(uint8 port, uint8 event)
   \                     SampleApp_CallBack:
    659          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    660            (void)port;
    661          
    662            HalUARTRead(SAMPLE_APP_PORT, SampleApp_RxBuf, 1);
   \   000004                ; Setup parameters for call to function HalUARTRead
   \   000004   7C01         MOV       R4,#0x1
   \   000006   7D00         MOV       R5,#0x0
   \   000008   7A..         MOV       R2,#SampleApp_RxBuf & 0xff
   \   00000A   7B..         MOV       R3,#(SampleApp_RxBuf >> 8) & 0xff
   \   00000C   7900         MOV       R1,#0x0
   \   00000E   12....       LCALL     `??HalUARTRead::?relay`; Banked call to: HalUARTRead
    663          
    664          }
   \   000011   D083         POP       DPH
   \   000013   D082         POP       DPL
   \   000015   02....       LJMP      ?BRET
    665          
    666          
    667          #endif
    668          
    669          
    670          //调试信息输出

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    671          void debug(uint8 * msg, ...)
   \                     debug:
    672          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    673          #if 0
    674              uint8 len=0;
    675              char info[200] = {0};
    676              va_list args;
    677          
    678              if(msg==NULL) return;
    679          
    680              va_start(args, msg);
    681              vsprintf(info, (const char*)msg, args);//从头插入到info中
    682              va_end(args);
    683              
    684              
    685              len=osal_strlen((char *)info);
    686              if(len==0) return;
    687              
    688              
    689          
    690              HalUARTWrite(1,info, len);//串口1发送
    691              osal_memset(info,'\0',200);
    692          //    HAL_UART_PORT_0
    693          #endif
    694          }
   \   000000   02....       LJMP      ?BRET

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for SampleApp_epDesc>`:
   \   000000   0B           DB 11
   \   000001   ....         DW SampleApp_TaskID
   \   000003   ....         DW SampleApp_SimpleDesc
   \   000005   00           DB 0

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0, 0, 0, 0, 0}>`:
   \   000000   00           DB 0
   \   000001   00           DB 0
   \   000002   00           DB 0
   \   000003   00           DB 0
   \   000004   00           DB 0

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0`:
   \   000000   00           DB 0
   \   000001   00           DB 0
   \   000002   00           DB 0
   \   000003   00           DB 0
   \   000004   00           DB 0
   \   000005   00           DB 0
   \   000006   00           DB 0
   \   000007   00           DB 0
   \   000008   00           DB 0
   \   000009   00           DB 0
   \   00000A   00           DB 0
   \   00000B   00           DB 0
   \   00000C   00           DB 0
   \   00000D   00           DB 0
   \   00000E   00           DB 0
   \   00000F   00           DB 0
   \   000010   00           DB 0
   \   000011   00           DB 0
   \   000012   00           DB 0
   \   000013   00           DB 0

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "T&H:%d %d">`:
   \   000000   5426483A     DB "T&H:%d %d"
   \            25642025
   \            6400    

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "\\r\\n">`:
   \   000000   0D0A00       DB "\015\012"
    695          
    696          

   Maximum stack usage in bytes:

   ISTACK XSTACK Function
   ------ ------ --------
      2      0   SampleApp_CallBack
        2      0   -> HalUARTRead
      0      0   SampleApp_HandleKeys
      0      9   SampleApp_Init
        0      9   -> MT_UartInit
        0      9   -> MT_UartRegisterTaskID
        0      9   -> RegisterForKeys
        0      9   -> afRegister
      0    145   SampleApp_ProcessEvent
        0    142   -> HalUARTWrite
        0    142   -> SampleApp_Send_P2P_Message
        0    145   -> osal_memcpy
        0    142   -> osal_memset
        0    142   -> osal_msg_deallocate
        0    142   -> osal_msg_receive
        0    142   -> osal_rand
        0    142   -> osal_start_timerEx
        0    142   -> osal_strlen
      1    186   SampleApp_Send_P2P_Message
        0     44   -> AF_DataRequest
        0     35   -> DHT11
        0     35   -> HalAdcInit
        0     35   -> HalAdcRead
        0     35   -> HalLcdWriteString
        0     35   -> HalUARTWrite
        0     35   -> osal_memset
        0     35   -> osal_strlen
        0     39   -> sprintf
      0      0   debug


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
      10  ?<Constant "T&H:%d %d">
       3  ?<Constant "\r\n">
      20  ?<Constant {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
       5  ?<Constant {0, 0, 0, 0, 0}>
       6  ?<Initializer for SampleApp_epDesc>
      12  ?Subroutine0
      24  SampleApp_CallBack
       8  SampleApp_ClusterList
       3  SampleApp_HandleKeys
      61  SampleApp_Init
       1  SampleApp_MsgID
       1  SampleApp_NwkState
      12  SampleApp_P2P_DstAddr
     256  SampleApp_ProcessEvent
     201  SampleApp_RxBuf
     302  SampleApp_Send_P2P_Message
      12  SampleApp_SimpleDesc
       1  SampleApp_TaskID
       6  SampleApp_epDesc
       1  _A_P1
       1  cor_led3
       3  debug
       1  end_hum
       1  end_led3
       1  end_light
       1  end_temp
       1  onenet_login_ok
      36  -- Other

 
 661 bytes in segment BANKED_CODE
  36 bytes in segment BANK_RELAYS
   1 byte  in segment SFR_AN
   6 bytes in segment XDATA_I
   6 bytes in segment XDATA_ID
  58 bytes in segment XDATA_ROM_C
 222 bytes in segment XDATA_Z
 
  42 bytes of CODE     memory
  58 bytes of CONST    memory
   0 bytes of DATA     memory (+ 1 byte shared)
 661 bytes of HUGECODE memory
 228 bytes of XDATA    memory

Errors: none
Warnings: 10
